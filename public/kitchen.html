<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    onSnapshot,
    deleteDoc,
    doc
  } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAsDV4gEEQZpJdK9sccKQLMG-vAEc9-KUc",
    authDomain: "nampanorder.firebaseapp.com",
    projectId: "nampanorder",
    storageBucket: "nampanorder.appspot.com",
    messagingSenderId: "123907265628",
    appId: "1:123907265628:web:b52fe97f50d4f97a57c299"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const ordersDiv = document.getElementById("orders");
  let lastOrderIds = new Set();

  const ordersRef = collection(db, "orders");

  // ‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
  if ("Notification" in window && Notification.permission !== "granted") {
    Notification.requestPermission();
  }

  onSnapshot(ordersRef, (snapshot) => {
    console.log("üì¶ Snapshot ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß:", snapshot.size);
    let html = "";
    const newOrderIds = new Set();
    console.log("‚úÖ Firebase ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

    snapshot.forEach((docSnap, index) => {
      const data = docSnap.data();
      const id = docSnap.id;
      newOrderIds.add(id);

      // ‡πÄ‡∏ß‡∏•‡∏≤
      let time = "-";
      try {
        if (data.timestamp?.seconds) {
          const date = new Date(data.timestamp.seconds * 1000);
          time = date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        } else if (typeof data.timestamp === "string" || typeof data.timestamp === "number") {
          const parsed = new Date(data.timestamp);
          if (!isNaN(parsed)) {
            time = parsed.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
          }
        }
      } catch (e) {
        console.error("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤:", e);
      }

      // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà
      if (!lastOrderIds.has(id) && Notification.permission === "granted") {
        new Notification("üì¶ ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà!", {
          body: `${data.name || "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"} ‡∏™‡∏±‡πà‡∏á ${data.item || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏°‡∏ô‡∏π"}`
        });
      }

      html += `
        <div class="order">
          <button class="delete-btn" onclick="deleteOrder('${id}')">‡∏•‡∏ö</button>
          <div class="order-number">#${snapshot.size - index}</div>
          <div>‡∏ä‡∏∑‡πà‡∏≠: ${data.name || "-"}</div>
          <div>‡πÄ‡∏°‡∏ô‡∏π: ${data.item || "-"}<br>‡∏´‡∏ß‡∏≤‡∏ô: ${data.sweet || "-"}</div>
          <div>‡∏ó‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á: ${data.topping || "-"}</div>
          <div class="note">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ${data.note || "-"}</div>
          <div class="time">‡πÄ‡∏ß‡∏•‡∏≤: ${time}</div>
        </div>
      `;
    });

    ordersDiv.innerHTML = html;
    lastOrderIds = newOrderIds;
  });

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
  window.deleteOrder = async function (id) {
    if (confirm("‡∏•‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
      try {
        await deleteDoc(doc(db, "orders", id));
      } catch (e) {
        alert("‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message);
      }
    }
  };
</script>
